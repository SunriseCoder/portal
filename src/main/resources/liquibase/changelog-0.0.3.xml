<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
                   logicalFilePath="changelog-0.0.3">

    <changeSet id="0.0.3-01" author="SunriseCoder">

        <createTable tableName="users">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_users" nullable="false" />
            </column>
            <column name="login" type="varchar(32)">
                <constraints unique="true" uniqueConstraintName="ui_users_login" nullable="false" />
            </column>
            <column name="pass" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="display_name" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_users_display_name" nullable="false" />
            </column>
            <column name="email" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_users_email" nullable="false" />
            </column>
        </createTable>

        <insert tableName="users">
            <column name="id" value="1" />
            <column name="login" value="admin" />
            <column name="pass" value="$2a$10$hHBkdPDV.oI6pXhmbLYdJucXyMl3FPWL3cHzSwm/0ieSwamSQ7fT6" /><!-- "password" -->
            <column name="display_name" value="Admin" />
            <column name="email" value="ch@ange.it" />
        </insert>

        <insert tableName="users">
            <column name="id" value="2" />
            <column name="login" value="moder" />
            <column name="pass" value="$2a$10$hHBkdPDV.oI6pXhmbLYdJucXyMl3FPWL3cHzSwm/0ieSwamSQ7fT6" /><!-- "password" -->
            <column name="display_name" value="Moder" />
            <column name="email" value="ch1@ange.it" />
        </insert>

        <!-- TODO Delete it before merge to develop branch -->
        <insert tableName="users">
            <column name="id" value="3" />
            <column name="login" value="user" />
            <column name="pass" value="$2a$10$hHBkdPDV.oI6pXhmbLYdJucXyMl3FPWL3cHzSwm/0ieSwamSQ7fT6" /><!-- "password" -->
            <column name="display_name" value="User" />
            <column name="email" value="ch2@ange.it" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-02" author="SunriseCoder">

        <createTable tableName="z_user_locks">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_user_locks" nullable="false" />
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" uniqueConstraintName="ui_user_locks_user_id"
                             foreignKeyName="fk_z_user_locks_user" referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="reason" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="locked_by_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_z_user_locks_by" referencedTableName="users" referencedColumnNames="id" />
            </column>
        </createTable>

    </changeSet>

    <changeSet id="0.0.3-03" author="SunriseCoder">

        <createTable tableName="z_user_confirms">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_user_confirms" nullable="false" />
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" uniqueConstraintName="ui_user_confirms_user_id"
                             foreignKeyName="fk_z_user_confirms_user" referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="comment" type="varchar(64)" />
            <column name="confirmed_by_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_z_user_confirms_by" referencedTableName="users" referencedColumnNames="id" />
            </column>
        </createTable>

    </changeSet>

    <changeSet id="0.0.3-04" author="SunriseCoder">

        <createTable tableName="persistent_logins">
            <column name="username" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="series" type="varchar(64)">
                <constraints primaryKey="true" primaryKeyName="pk_persistent_logins" nullable="false" />
            </column>
            <column name="token" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="last_used" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>

    </changeSet>

    <changeSet id="0.0.3-05" author="SunriseCoder">

        <createTable tableName="permissions">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="permissionsPK" />
            </column>
            <column name="name" type="VARCHAR(64)">
                <constraints unique="true" uniqueConstraintName="ui_permissions_name" nullable="false" />
            </column>
            <column name="comment" type="VARCHAR(255)" />
        </createTable>

        <insert tableName="permissions">
            <column name="id" value="1" />
            <column name="name" value="ADMIN_PAGE" />
            <column name="comment" value="Allows access to administration section" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="2" />
            <column name="name" value="UPLOAD_FILES" />
            <column name="comment" value="Allows users to upload files to server" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="3" />
            <column name="name" value="ADMIN_DASHBOARD" />
            <column name="comment" value="Allows access to administration dashboard" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="4" />
            <column name="name" value="ADMIN_USERS_VIEW" />
            <column name="comment" value="Allows access to View user information" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="5" />
            <column name="name" value="ADMIN_USERS_EDIT" />
            <column name="comment" value="Allows access to Edit user information" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="6" />
            <column name="name" value="ADMIN_USERS_ROLES" />
            <column name="comment" value="Allows access to change user permissions" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="7" />
            <column name="name" value="ADMIN_USERS_LOCK" />
            <column name="comment" value="Allows to lock users" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="8" />
            <column name="name" value="ADMIN_USERS_UNLOCK" />
            <column name="comment" value="Allows to unlock users" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="9" />
            <column name="name" value="PAGES_VIEW" />
            <column name="comment" value="Allows to view base pages" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="10" />
            <column name="name" value="ADMIN_USERS_CONFIRM" />
            <column name="comment" value="Allows to confirm user identity" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="11" />
            <column name="name" value="ADMIN_USERS_UNCONFIRM" />
            <column name="comment" value="Allows to reject identity confirmation" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="12" />
            <column name="name" value="ADMIN_ROLES_VIEW" />
            <column name="comment" value="Allows to reject identity confirmation" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="13" />
            <column name="name" value="ADMIN_ROLES_EDIT" />
            <column name="comment" value="Allows to reject identity confirmation" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="14" />
            <column name="name" value="ADMIN_AUDIT_VIEW" />
            <column name="comment" value="Allows to view audit events" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-06" author="SunriseCoder">

        <createTable tableName="roles">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="rolesPK" />
            </column>
            <column name="name" type="VARCHAR(64)">
                <constraints unique="true" uniqueConstraintName="ui_roles_name" nullable="false" />
            </column>
            <column name="comment" type="VARCHAR(255)" />
        </createTable>

        <insert tableName="roles">
            <column name="id" value="1" />
            <column name="name" value="Admin" />
            <column name="comment" value="Admin with full permissions" />
        </insert>

        <insert tableName="roles">
            <column name="id" value="2" />
            <column name="name" value="User" />
            <column name="comment" value="Just an ordinary registered user" />
        </insert>

        <insert tableName="roles">
            <column name="id" value="3" />
            <column name="name" value="Moder" />
            <column name="comment" value="Moderator with partial administration permissions" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-07" author="SunriseCoder">

        <createTable tableName="zz_roles_permissions">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_permissions_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
            <column name="permission_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_permissions_permission"
                    referencedTableName="permissions" referencedColumnNames="id" />
            </column>
        </createTable>

        <!-- Grant Permission ADMIN_PAGE to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="1" />
        </insert>

        <!-- Grant Permission ADMIN_DASHBOARD to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="3" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_VIEW to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="4" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_EDIT to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="5" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_ROLES to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="6" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_LOCK to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="7" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_UNLOCK to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="8" />
        </insert>

        <!-- Grant Permission PAGES_VIEW to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="9" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_CONFIRM to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="10" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_UNCONFIRM to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="11" />
        </insert>

        <!-- Grant Permission ADMIN_ROLES_VIEW to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="12" />
        </insert>

        <!-- Grant Permission ADMIN_ROLES_EDIT to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="13" />
        </insert>

        <!-- Grant Permission ADMIN_AUDIT_VIEW to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="14" />
        </insert>

        <!-- Grant Permission UPLOAD_FILES to Role User -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="2" />
            <column name="permission_id" value="2" />
        </insert>

        <!-- Grant Permission PAGES_VIEW to Role User -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="2" />
            <column name="permission_id" value="9" />
        </insert>

        <!-- Grant Permission ADMIN_PAGE to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="1" />
        </insert>

        <!-- Grant Permission ADMIN_DASHBOARD to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="3" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_VIEW to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="4" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_EDIT to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="5" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_LOCK to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="7" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_UNLOCK to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="8" />
        </insert>

        <!-- Grant Permission PAGES_VIEW to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="9" />
        </insert>

        <!-- Grant Permission ADMIN_USERS_CONFIRM to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="10" />
        </insert>

        <!-- Grant Permission ADMIN_ROLES_VIEW to Role Moder -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="3" />
            <column name="permission_id" value="12" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-08" author="SunriseCoder">

        <createTable tableName="zz_users_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_user_roles_user"
                    referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_users_roles_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
        </createTable>

        <!-- Grant Role Admin to User Admin -->
        <insert tableName="zz_users_roles">
            <column name="user_id" value="1" />
            <column name="role_id" value="1" />
        </insert>

        <!-- Grant Role Moder to User Moder -->
        <insert tableName="zz_users_roles">
            <column name="user_id" value="2" />
            <column name="role_id" value="3" />
        </insert>

        <!-- TODO Delete it before merge to develop branch -->
        <!-- Grant Role User to User User -->
        <insert tableName="zz_users_roles">
            <column name="user_id" value="3" />
            <column name="role_id" value="2" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-09" author="SunriseCoder">

        <createTable tableName="audit_event_types">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_audit_event_types" nullable="false" />
            </column>
            <column name="name" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_audit_event_type_name" nullable="false" />
            </column>
            <column name="comment" type="varchar(64)" />
            <column name="severity" type="tinyint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <insert tableName="audit_event_types">
            <column name="id" value="1" />
            <column name="name" value="ACCESS_ALLOWED" />
            <column name="comment" value="Access to particular resource is allowed" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="2" />
            <column name="name" value="ACCESS_DENIED" />
            <column name="comment" value="Access to particular resource is denied" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="3" />
            <column name="name" value="AUDIT_FAILURE" />
            <column name="comment" value="Audit failure" />
            <column name="severity" valueNumeric="2" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="4" />
            <column name="name" value="ENTITY_NOT_EXISTS" />
            <column name="comment" value="Entity was not found" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="5" />
            <column name="name" value="SAVING_ERROR" />
            <column name="comment" value="Saving error, however validation was passed" />
            <column name="severity" valueNumeric="2" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="6" />
            <column name="name" value="VALIDATION_ERROR" />
            <column name="comment" value="Incorrect field value" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="audit_event_types">
            <column name="id" value="7" />
            <column name="name" value="SUCCESSFUL" />
            <column name="comment" value="Operation completed successfully" />
            <column name="severity" valueNumeric="0" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-10" author="SunriseCoder">

        <createTable tableName="operation_types">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_operation_types" nullable="false" />
            </column>
            <column name="name" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_operation_type_name" nullable="false" />
            </column>
            <column name="comment" type="varchar(64)" />
            <column name="severity" type="tinyint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <insert tableName="operation_types">
            <column name="id" value="1" />
            <column name="name" value="ACCESS_ADMIN_DASHBOARD" />
            <column name="comment" value="Access to admin dashboard" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="operation_types">
            <column name="id" value="2" />
            <column name="name" value="SAVE_AUDIT_EVENT" />
            <column name="comment" value="Saving audit event" />
            <column name="severity" valueNumeric="2" />
        </insert>

        <insert tableName="operation_types">
            <column name="id" value="3" />
            <column name="name" value="ACCESS_USER_LIST" />
            <column name="comment" value="Viewing user list" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="operation_types">
            <column name="id" value="4" />
            <column name="name" value="ACCESS_USER_EDIT" />
            <column name="comment" value="Changing user data" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="operation_types">
            <column name="id" value="5" />
            <column name="name" value="CHANGE_USER_LOGIN" />
            <column name="comment" value="Changing user login" />
            <column name="severity" valueNumeric="1" />
        </insert>

        <insert tableName="operation_types">
            <column name="id" value="6" />
            <column name="name" value="CHANGE_USER_PASSWORD" />
            <column name="comment" value="Changing user password" />
            <column name="severity" valueNumeric="1" />
        </insert>

    </changeSet>

    <changeSet id="0.0.3-11" author="SunriseCoder">

        <createTable tableName="audit_events">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_audit_events" nullable="false" />
            </column>
            <column name="user_id" type="BIGINT">
                <constraints foreignKeyName="fk_audit_events_user"
                             referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="ip" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="operation_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_audit_events_operation_type"
                             referencedTableName="operation_types" referencedColumnNames="id" />
            </column>
            <column name="type_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_audit_events_type"
                             referencedTableName="audit_event_types" referencedColumnNames="id" />
            </column>
            <column name="object_before" type="varchar(255)" />
            <column name="object_after" type="varchar(255)" />
            <column name="error" type="varchar(255)" />
        </createTable>

    </changeSet>

</databaseChangeLog>
