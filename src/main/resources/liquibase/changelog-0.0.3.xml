<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
                   logicalFilePath="changelog-0.0.3">

    <changeSet author="SunriseCoder" id="0.0.3-01">

        <createTable tableName="users">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_users" nullable="false" />
            </column>
            <column name="login" type="varchar(32)">
                <constraints unique="true" uniqueConstraintName="ui_users_login" nullable="false" />
            </column>
            <column name="pass" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="display_name" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_users_display_name" nullable="false" />
            </column>
            <column name="email" type="varchar(64)">
                <constraints unique="true" uniqueConstraintName="ui_users_email" nullable="false" />
            </column>
        </createTable>

        <insert tableName="users">
            <column name="id" value="1" />
            <column name="login" value="admin" />
            <column name="pass" value="$2a$10$hHBkdPDV.oI6pXhmbLYdJucXyMl3FPWL3cHzSwm/0ieSwamSQ7fT6" /><!-- "password" -->
            <column name="display_name" value="Admin" />
            <column name="email" value="ch@ange.it" />
        </insert>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-02">

        <createTable tableName="persistent_logins">
            <column name="username" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="series" type="varchar(64)">
                <constraints primaryKey="true" primaryKeyName="pk_persistent_logins" nullable="false" />
            </column>
            <column name="token" type="varchar(64)">
                <constraints nullable="false" />
            </column>
            <column name="last_used" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-03">

        <createTable tableName="permissions">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="permissionsPK" />
            </column>
            <column name="name" type="VARCHAR(64)">
                <constraints unique="true" uniqueConstraintName="ui_permissions_name" nullable="false" />
            </column>
            <column name="comment" type="VARCHAR(255)" />
        </createTable>

        <insert tableName="permissions">
            <column name="id" value="1" />
            <column name="name" value="ADMIN_PAGE" />
            <column name="comment" value="Allows access to administration section" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="2" />
            <column name="name" value="UPLOAD_FILES" />
            <column name="comment" value="Allows users to upload files to server" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="3" />
            <column name="name" value="ADMIN_DASHBOARD" />
            <column name="comment" value="Allows access to administration dashboard" />
        </insert>

        <insert tableName="permissions">
            <column name="id" value="4" />
            <column name="name" value="ADMIN_USERS" />
            <column name="comment" value="Allows access to administration dashboard" />
        </insert>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-04">

        <createTable tableName="roles">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="rolesPK" />
            </column>
            <column name="name" type="VARCHAR(64)">
                <constraints unique="true" uniqueConstraintName="ui_roles_name" nullable="false" />
            </column>
            <column name="comment" type="VARCHAR(255)" />
        </createTable>

        <insert tableName="roles">
            <column name="id" value="1" />
            <column name="name" value="Admin" />
            <column name="comment" value="Admin with full permissions" />
        </insert>

        <insert tableName="roles">
            <column name="id" value="2" />
            <column name="name" value="User" />
            <column name="comment" value="Just an ordinary registered user" />
        </insert>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-05">

        <createTable tableName="zz_roles_permissions">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_permissions_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
            <column name="permission_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_permissions_permission"
                    referencedTableName="permissions" referencedColumnNames="id" />
            </column>
        </createTable>

        <!-- Grant Permission ADMIN_PAGE to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="1" />
        </insert>

        <!-- Grant Permission UPLOAD_FILES to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="2" />
        </insert>

        <!-- Grant Permission ADMIN_DASHBOARD to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="3" />
        </insert>

        <!-- Grant Permission ADMIN_USERS to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="1" />
            <column name="permission_id" value="4" />
        </insert>

        <!-- Grant Permission UPLOAD_FILES to Role User -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="2" />
            <column name="permission_id" value="2" />
        </insert>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-06">

        <createTable tableName="zz_roles_roles">
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_roles_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
            <column name="included_role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_roles_roles_included_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
        </createTable>

    </changeSet>

    <changeSet author="SunriseCoder" id="0.0.3-07">

        <createTable tableName="zz_users_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_user_roles_user"
                    referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="role_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_zz_users_roles_role"
                    referencedTableName="roles" referencedColumnNames="id" />
            </column>
        </createTable>

        <!-- Grant Role Admin to User Admin -->
        <insert tableName="zz_users_roles">
            <column name="user_id" value="1" />
            <column name="role_id" value="1" />
        </insert>

    </changeSet>

</databaseChangeLog>
