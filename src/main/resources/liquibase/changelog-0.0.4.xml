<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"
                   logicalFilePath="changelog-0.0.4">

    <changeSet id="0.0.4-01" author="SunriseCoder">

        <createTable tableName="storage_files">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_storage_files" nullable="false" />
            </column>
            <column name="title" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="event_day" type="int">
                <constraints nullable="true" />
            </column>
            <column name="event_month" type="int">
                <constraints nullable="true" />
            </column>
            <column name="event_year" type="int">
                <constraints nullable="true" />
            </column>
            <column name="filename" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="uploaded_by_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_storage_files_uploaded_by"
                             referencedTableName="users" referencedColumnNames="id" />
            </column>
            <column name="size" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="chunk_size" type="int">
                <constraints nullable="false" />
            </column>
            <column name="check_sum" type="varchar(32)">
                <constraints nullable="true" />
            </column>
            <column name="uploaded_bytes" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="path" type="varchar(255)">
                <constraints unique="true" uniqueConstraintName="ui_storage_files_path" nullable="false" />
            </column>
            <column name="completed" type="boolean">
                <constraints nullable="false" />
            </column>
            <column name="published" type="boolean">
                <constraints nullable="false" />
            </column>
            <column name="deleted" type="boolean">
                <constraints nullable="false" />
            </column>
            <column name="last_updated" type="datetime">
                <constraints nullable="false" />
            </column>
        </createTable>

    </changeSet>

    <changeSet id="0.0.4-02" author="SunriseCoder">

        <insert tableName="e_operation_types">
            <column name="id" value="52" />
            <column name="name" value="CHANGE_FILE_CREATE_PLACEHOLDER" />
            <column name="comment" value="Creating file placeholder as initializing of file upload" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="e_operation_types">
            <column name="id" value="53" />
            <column name="name" value="CHANGE_FILE_UPLOAD_CHUNK" />
            <column name="comment" value="Uploading a file chunk as a part of a file" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="e_operation_types">
            <column name="id" value="54" />
            <column name="name" value="CHANGE_FILE_DELETE_PLACEHOLDER" />
            <column name="comment" value="Deleting an incomplete file placeholder" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="e_operation_types">
            <column name="id" value="55" />
            <column name="name" value="CHANGE_FILE_UPDATE_INFO" />
            <column name="comment" value="Updating file placeholder's information" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="e_operation_types">
            <column name="id" value="56" />
            <column name="name" value="CHANGE_FILE_PUBLISH" />
            <column name="comment" value="Make a file visible for other users" />
            <column name="severity" valueNumeric="0" />
        </insert>

        <insert tableName="e_operation_types">
            <column name="id" value="57" />
            <column name="name" value="CHANGE_FILE_UNPUBLISH" />
            <column name="comment" value="Make a publicly visible file unvisible for other users" />
            <column name="severity" valueNumeric="1" />
        </insert>

    </changeSet>

    <changeSet id="0.0.4-03" author="SunriseCoder">

        <insert tableName="e_permissions">
            <column name="id" value="29" />
            <column name="name" value="ADMIN_FILES_PUBLISH" />
            <column name="comment" value="Permission to publish files, uploaded by other users" />
        </insert>

        <!-- Grant Permission ADMIN_FILES_PUBLISH to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="2" />
            <column name="permission_id" value="29" />
        </insert>

        <insert tableName="e_permissions">
            <column name="id" value="30" />
            <column name="name" value="ADMIN_FILES_DELETE" />
            <column name="comment" value="Permission to delete files, uploaded by other users" />
        </insert>

        <!-- Grant Permission ADMIN_FILES_DELETE to Role Admin -->
        <insert tableName="zz_roles_permissions">
            <column name="role_id" value="2" />
            <column name="permission_id" value="30" />
        </insert>

    </changeSet>

    <changeSet id="0.0.4-04" author="SunriseCoder">

        <createTable tableName="albums">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_albums"/>
            </column>
            <column name="name" type="varchar(255)"/>
        </createTable>

        <createTable tableName="zz_albums_files">
            <column name="album_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_zz_albums_files_album"
                    referencedTableName="albums" referencedColumnNames="id" />
            </column>
            <column name="file_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_zz_albums_files_file"
                    referencedTableName="storage_files" referencedColumnNames="id" />
            </column>
        </createTable>

        <createTable tableName="zz_festivals_albums">
            <column name="festival_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_zz_festivals_albums_festival"
                    referencedTableName="festivals" referencedColumnNames="id" />
            </column>
            <column name="album_id" type="bigint">
                <constraints nullable="false" foreignKeyName="fk_zz_festivals_albums_album"
                    referencedTableName="albums" referencedColumnNames="id" />
            </column>
        </createTable>

    </changeSet>

</databaseChangeLog>
